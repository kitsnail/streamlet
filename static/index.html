<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频库 - Streamlet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .video-card:hover { transform: translateY(-2px); }
        .thumbnail-placeholder {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        .toast-enter { animation: slideIn 0.3s ease-out; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F172A',
                        accent: '#3B82F6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-20 right-4 z-[60] flex flex-col gap-2 max-w-sm"></div>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-slate-800/80 backdrop-blur-lg border-b border-slate-700/50 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-accent rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span class="text-white font-semibold text-lg">Streamlet</span>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <div class="relative">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="搜索视频..."
                            class="w-64 px-4 py-2 pl-10 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors duration-200"
                        >
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>

                    <!-- Sort -->
                    <select id="sortSelect" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors duration-200 cursor-pointer">
                        <option value="modified">最新修改</option>
                        <option value="hotness">热度</option>
                        <option value="views">播放</option>
                        <option value="likes">喜欢</option>
                        <option value="name">名称</option>
                        <option value="size">大小</option>
                    </select>

                    <a href="/playlists" class="px-4 py-2 text-slate-300 hover:text-white transition-colors duration-200 cursor-pointer flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span class="hidden sm:inline">播放列表</span>
                    </a>

                    <!-- Logout -->
                    <button
                        onclick="logout()"
                        class="px-4 py-2 text-slate-400 hover:text-white transition-colors duration-200 cursor-pointer"
                        aria-label="退出登录"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <!-- Stats -->
        <div class="mb-6 flex items-center justify-between">
            <p class="text-slate-400">
                共 <span id="totalCount" class="text-white font-semibold">0</span> 个视频
            </p>
            <div id="pageInfo" class="text-slate-400 text-sm">
                第 <span id="currentPage" class="text-white">1</span> 页 / 共 <span id="totalPages" class="text-white">1</span> 页
            </div>
        </div>

        <!-- Video Grid -->
        <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Loading skeleton -->
            <div class="animate-pulse bg-slate-800 rounded-xl h-56"></div>
            <div class="animate-pulse bg-slate-800 rounded-xl h-56"></div>
            <div class="animate-pulse bg-slate-800 rounded-xl h-56"></div>
            <div class="animate-pulse bg-slate-800 rounded-xl h-56"></div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-20">
            <svg class="mx-auto w-16 h-16 text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <p class="text-slate-400 text-lg">暂无视频</p>
            <p class="text-slate-500 text-sm mt-2">请检查视频目录配置</p>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden mt-8 flex items-center justify-center gap-2">
            <button onclick="goToPage(1)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" id="firstPageBtn" aria-label="第一页">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
            </button>
            <button onclick="goToPage(currentPage - 1)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" id="prevPageBtn" aria-label="上一页">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div id="pageNumbers" class="flex items-center gap-1"></div>
            <button onclick="goToPage(currentPage + 1)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" id="nextPageBtn" aria-label="下一页">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
            <button onclick="goToPage(totalPages)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" id="lastPageBtn" aria-label="最后一页">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
            </button>
        </div>
    </main>

    <!-- Add to Playlist Modal -->
    <div id="playlistModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-semibold text-white mb-4">添加到播放列表</h2>
            <div id="playlistList" class="space-y-2">
                <!-- Playlists will be inserted here -->
            </div>
            
            <!-- Create New Playlist Section -->
            <div class="mt-4 pt-4 border-t border-slate-700">
                <p class="text-slate-400 text-sm mb-3">或创建新播放列表</p>
                <form id="createPlaylistForm" class="flex gap-2">
                    <input
                        type="text"
                        id="newPlaylistName"
                        placeholder="输入播放列表名称"
                        class="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors duration-200"
                    >
                    <button
                        type="submit"
                        class="px-4 py-2 bg-accent hover:bg-blue-600 text-white font-medium rounded-xl transition-colors duration-200 cursor-pointer whitespace-nowrap"
                    >
                        创建
                    </button>
                </form>
            </div>
            
            <button onclick="hidePlaylistModal()" class="mt-4 w-full px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-xl transition-colors duration-200 cursor-pointer">
                取消
            </button>
        </div>
    </div>

    <script>
        let currentPage = 1, totalPages = 1, pageSize = 50;
        let currentSearch = '', currentSort = 'modified';
        let searchTimeout = null;
        let currentVideoPath = null;
        let playlists = [];

        // Toast notification system
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' 
                ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                : type === 'error'
                ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
                : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
            
            toast.className = `toast-enter ${bgColor} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3`;
            toast.innerHTML = `${icon}<span class="font-medium">${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function renderVideo(video, index) {
            const thumbnailUrl = `/api/thumbnail?video=${encodeURIComponent(video.path)}`;
            const likeIcon = video.liked 
                ? '<svg class="w-4 h-4 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'
                : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>';
            
            // Build player URL with pagination context for auto-playlist
            const playerUrl = buildPlayerUrl(video.path, index);
            
            return `
                <div class="video-card bg-slate-800 rounded-xl overflow-hidden border border-slate-700/50 hover:border-accent/50 transition-all duration-200">
                    <a href="${playerUrl}" onclick="recordView('${video.path}', '${video.name.replace(/'/g, "\\'")}')">
                        <div class="aspect-video thumbnail-placeholder flex items-center justify-center relative overflow-hidden">
                            <img src="${thumbnailUrl}" alt="${video.name}" class="w-full h-full object-cover" onerror="this.style.display='none';">
                            <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm px-2 py-1 rounded-lg text-white text-xs flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                ${formatNumber(video.views)}
                            </div>
                        </div>
                    </a>
                    <div class="p-4">
                        <h3 class="text-white font-medium truncate" title="${video.name}">${video.name}</h3>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-sm text-slate-400">${formatSize(video.size)}</span>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleLike('${video.path}', '${video.name.replace(/'/g, "\\'")}', this)" class="flex items-center gap-1 text-sm ${video.liked ? 'text-red-400' : 'text-slate-400'} hover:text-red-400 transition-colors duration-200 cursor-pointer" aria-label="${video.liked ? '取消喜欢' : '喜欢'}">
                                    ${likeIcon}
                                    <span>${formatNumber(video.likes)}</span>
                                </button>
                                <button onclick="showPlaylistModal('${video.path}')" class="p-1 text-slate-400 hover:text-accent transition-colors duration-200 cursor-pointer" aria-label="添加到播放列表">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function recordView(path, name) {
            try { await fetch('/api/view', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path, name }) }); } catch (e) {}
        }

        async function toggleLike(path, name, btn) {
            try {
                const response = await fetch('/api/like', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path, name }) });
                const data = await response.json();
                const icon = btn.querySelector('svg'), count = btn.querySelector('span');
                if (data.liked) {
                    btn.classList.remove('text-slate-400'); btn.classList.add('text-red-400');
                    icon.outerHTML = '<svg class="w-4 h-4 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
                } else {
                    btn.classList.remove('text-red-400'); btn.classList.add('text-slate-400');
                    icon.outerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>';
                }
                count.textContent = formatNumber(data.likes);
            } catch (e) {}
        }

        async function showPlaylistModal(videoPath) {
            currentVideoPath = videoPath;
            try {
                const response = await fetch('/api/playlists');
                const data = await response.json();
                playlists = data.playlists || [];
                
                const list = document.getElementById('playlistList');
                if (playlists.length === 0) {
                    list.innerHTML = '<p class="text-slate-400 text-center py-4">暂无播放列表，请在下方创建</p>';
                } else {
                    list.innerHTML = playlists.map(p => `
                        <button onclick="addToPlaylist('${p.id}')" class="w-full px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-xl transition-colors duration-200 cursor-pointer text-left flex items-center justify-between">
                            <span>${p.name}</span>
                            <span class="text-slate-400 text-sm">${p.videos ? p.videos.length : 0} 个视频</span>
                        </button>
                    `).join('');
                }
                document.getElementById('playlistModal').classList.remove('hidden');
                document.getElementById('newPlaylistName').value = '';
            } catch (e) { console.error(e); }
        }

        function hidePlaylistModal() {
            document.getElementById('playlistModal').classList.add('hidden');
            currentVideoPath = null;
        }

        async function addToPlaylist(playlistId) {
            try {
                const response = await fetch('/api/playlists/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playlistId, videoPath: currentVideoPath })
                });
                if (response.ok) {
                    hidePlaylistModal();
                    showToast('已添加到播放列表');
                }
            } catch (e) { 
                showToast('添加失败', 'error');
            }
        }

        // Create new playlist form handler
        document.getElementById('createPlaylistForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newPlaylistName').value.trim();
            if (!name) {
                showToast('请输入播放列表名称', 'error');
                return;
            }

            try {
                const response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: '' })
                });
                if (response.ok) {
                    const newPlaylist = await response.json();
                    showToast('播放列表已创建');
                    // Refresh the list and add the video
                    await showPlaylistModal(currentVideoPath);
                }
            } catch (e) {
                showToast('创建失败', 'error');
            }
        });

        function renderVideos(videos) {
            const grid = document.getElementById('videoGrid'), empty = document.getElementById('emptyState');
            if (!videos.length) { grid.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            grid.classList.remove('hidden'); empty.classList.add('hidden');
            grid.innerHTML = videos.map((v, i) => renderVideo(v, i)).join('');
        }

        // Build player URL with pagination context
        function buildPlayerUrl(videoPath, index) {
            const params = new URLSearchParams();
            params.set('v', videoPath);
            params.set('index', index.toString());
            params.set('page', currentPage.toString());
            params.set('pageSize', pageSize.toString());
            params.set('sort', currentSort);
            if (currentSearch) params.set('search', currentSearch);
            params.set('autoPlaylist', '1');
            return `/player?${params.toString()}`;
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination'), pageNumbers = document.getElementById('pageNumbers');
            if (totalPages <= 1) { pagination.classList.add('hidden'); return; }
            pagination.classList.remove('hidden');
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
            let pages = [], maxVisible = 5, start = Math.max(1, currentPage - Math.floor(maxVisible / 2)), end = Math.min(totalPages, start + maxVisible - 1);
            if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
            for (let i = start; i <= end; i++) pages.push(i);
            pageNumbers.innerHTML = pages.map(p => `<button onclick="goToPage(${p})" class="px-4 py-2 rounded-lg transition-colors duration-200 cursor-pointer ${p === currentPage ? 'bg-accent text-white' : 'bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white'}">${p}</button>`).join('');
        }

        function goToPage(page) { if (page < 1 || page > totalPages || page === currentPage) return; currentPage = page; fetchVideos(); }

        async function fetchVideos() {
            try {
                const params = new URLSearchParams({ page: currentPage, pageSize: pageSize, sort: currentSort });
                if (currentSearch) params.append('search', currentSearch);
                const response = await fetch(`/api/videos?${params}`);
                if (response.status === 401) { window.location.href = '/login'; return; }
                const data = await response.json();
                totalPages = data.totalPages || 1;
                document.getElementById('totalCount').textContent = data.total || 0;
                renderVideos(data.videos || []);
                renderPagination();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { console.error(e); }
        }

        function logout() { document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;'; window.location.href = '/login'; }

        document.getElementById('searchInput').addEventListener('input', (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentSearch = e.target.value.trim(); currentPage = 1; fetchVideos(); }, 300); });
        document.getElementById('sortSelect').addEventListener('change', (e) => { currentSort = e.target.value; currentPage = 1; fetchVideos(); });

        fetchVideos();
    </script>
</body>
</html>
